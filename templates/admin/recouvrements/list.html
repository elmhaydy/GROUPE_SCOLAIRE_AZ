{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Recouvrements | AZ{% endblock %}
{% block page_title %}Recouvrements{% endblock %}
{% block current_page %}Finance / Recouvrements{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/recouvrement/list.css' %}">
{% endblock %}

{% block content %}

<div class="az-page-head">
  <div class="az-page-head-left">
    <div class="az-pill">
      {% if annee_active %}
        <i class="fa-solid fa-circle-check"></i>
        <span>Année active : <b>{{ annee_active.nom }}</b></span>
      {% else %}
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>Aucune année active</span>
      {% endif %}
    </div>
  </div>

  <div class="az-page-head-right">
    <span class="az-pill az-pill-kpi">
      <i class="fa-solid fa-folder-open"></i>
      <span>Dossiers : <b>{{ total_dossiers }}</b></span>
    </span>
  </div>
</div>

<div class="az-filter-bar">
  <form method="get" class="az-filter-form">

    <div class="az-filter-label">
      <i class="fa-solid fa-filter"></i>
      <span>Filtres</span>
    </div>

    <div class="az-field">
      <div class="az-field-label">Recherche</div>
      <input class="az-input" name="q" value="{{ q }}" placeholder="Matricule, nom, groupe...">
    </div>

    <div class="az-field">
      <div class="az-field-label">Année</div>
      <select name="annee" class="az-select">
        <option value="">(Auto: année active)</option>
        {% for a in annees %}
          <option value="{{ a.id }}" {% if a.id|stringformat:"s" == annee_selected %}selected{% endif %}>
            {{ a.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Statut</div>
      <select name="statut" class="az-select">
        <option value="">Tous</option>
        {% for code,label in STATUT_CHOICES %}
          <option value="{{ code }}" {% if code == statut_selected %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <label class="az-check">
      <input type="hidden" name="sans_relance" value="0">
      <input type="checkbox" name="sans_relance" value="1" {% if sans_relance == "1" %}checked{% endif %}>
      <span>Sans relance</span>
    </label>

    <button class="az-btn az-btn-soft" type="submit">
      <i class="fa-solid fa-magnifying-glass"></i> Filtrer
    </button>

    <a class="az-btn az-btn-ghost" href="{% url 'core:recouvrement_list' %}">
      <i class="fa-solid fa-rotate-right"></i> Reset
    </a>

  </form>
</div>

<div class="az-card az-rec-card">
  <div class="az-card-head">
    <h3 class="az-card-title">
      <i class="fa-solid fa-list-check"></i>
      Liste des dossiers
    </h3>
  </div>

  <div class="az-table">
    <div class="az-thead">
      <div>Élève</div>
      <div>Année</div>
      <div>Groupe</div>
      <div>Statut</div>
      <div>Ouverture</div>
      <div>Dernière relance</div>
      <div class="az-th-actions">Action</div>
    </div>

    <div class="az-tbody">
      {% for d in dossiers %}

        {% comment %}
          En retard si date_ouverture <= date_limite et statut != REGLE/CLOTURE
        {% endcomment %}
        <div class="az-row
          {% if d.date_ouverture <= date_limite and d.statut != 'REGLE' and d.statut != 'CLOTURE' %}
            az-row-late
          {% endif %}
        ">

          <div class="az-cell">
            <span class="az-strong">{{ d.inscription.eleve.matricule }}</span>
            <span class="az-muted"> — {{ d.inscription.eleve.nom }} {{ d.inscription.eleve.prenom }}</span>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-muted">
              <i class="fa-solid fa-calendar-days"></i> {{ d.inscription.annee.nom }}
            </span>
          </div>

          <div class="az-cell">
            <b>{{ d.inscription.groupe.nom }}</b>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-statut az-statut-{{ d.statut|lower }}">
              <i class="fa-solid fa-tag"></i> {{ d.get_statut_display }}
            </span>

            {% if d.relances_count >= 3 and d.statut != 'REGLE' and d.statut != 'CLOTURE' %}
              <span class="az-badge az-badge-alert">
                <i class="fa-solid fa-triangle-exclamation"></i> {{ d.relances_count }} relances
              </span>
            {% elif d.relances_count > 0 %}
              <span class="az-badge az-badge-info">
                <i class="fa-solid fa-bell"></i> {{ d.relances_count }} relance{% if d.relances_count > 1 %}s{% endif %}
              </span>
            {% endif %}
            {% if d.date_ouverture <= date_limite and d.statut != 'REGLE' and d.statut != 'CLOTURE' %}
              <span class="az-badge az-badge-urgent">
                <i class="fa-solid fa-fire"></i> URGENT
              </span>
            {% endif %}

          </div>

          <div class="az-cell">
            {{ d.date_ouverture }}
          </div>

          <div class="az-cell">
            {% if d.last_relance_at %}
              {{ d.last_relance_at|date:"Y-m-d H:i" }}
            {% else %}
              <span class="az-muted">—</span>
            {% endif %}
          </div>

          <div class="az-cell az-actions">
            <a class="az-btn az-btn-primary" href="{% url 'core:recouvrement_detail' d.id %}">
              <i class="fa-solid fa-folder-open"></i> Ouvrir
            </a>
          </div>

        </div>

      {% empty %}
        <div class="az-empty">
          <i class="fa-solid fa-inbox"></i>
          <div>Aucun dossier.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}
