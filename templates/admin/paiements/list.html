{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Paiements | AZ{% endblock %}
{% block page_title %}Paiements{% endblock %}
{% block current_page %}Finance / Paiements / Parents{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/paiements/list.css' %}?v=3">
{% endblock %}

{% block content %}

<div class="az-page-head">
  <div class="az-page-head-left">
    <div class="az-pill">
      {% if annee_active %}
        <i class="fa-solid fa-circle-check"></i>
        <span>Année active : <b>{{ annee_active.nom }}</b></span>
      {% else %}
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>Aucune année active</span>
      {% endif %}
    </div>
  </div>

  <div class="az-page-head-right">
    <span class="az-pill az-pill-total">
      <i class="fa-solid fa-sack-dollar"></i>
      <span>Net : <b>{{ total_net }}</b> MAD</span>
    </span>

    <span class="az-pill">
      <i class="fa-solid fa-coins"></i>
      <span>Brut : <b>{{ total_brut }}</b> MAD</span>
    </span>

    <span class="az-pill">
      <i class="fa-solid fa-rotate-left"></i>
      <span>Remboursé : <b>{{ total_rembourse }}</b> MAD</span>
    </span>

    <a class="az-btn az-btn-primary" href="{% url 'core:transaction_wizard' %}">
      <i class="fa-solid fa-wand-magic-sparkles"></i> Nouveau paiement
    </a>
  </div>
</div>

{# ✅ garde ton filter form identique #}
<div class="az-filter-bar">
  <form method="get" class="az-filter-form">
    <div class="az-filter-label">
      <i class="fa-solid fa-filter"></i>
      <span>Filtres</span>
    </div>

    <div class="az-field">
      <div class="az-field-label">Année</div>
      <select id="id_annee" name="annee" class="az-select">
        <option value="">(Auto: année active)</option>
        {% for a in annees %}
          <option value="{{ a.id }}" {% if a.id|stringformat:"s" == annee_selected %}selected{% endif %}>
            {{ a.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Recherche</div>
      <input class="az-input" name="q" value="{{ q }}" placeholder="Nom enfant, matricule, tel...">
    </div>

    <div class="az-field">
      <div class="az-field-label">Mode</div>
      <select name="mode" class="az-select">
        <option value="">Tous</option>
        {% for value, label in modes %}
          <option value="{{ value }}" {% if value == mode_selected %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Niveau</div>
      <select id="id_niveau" name="niveau" class="az-select az-select-wide">
        <option value="">Tous</option>
        {% for n in niveaux %}
          <option value="{{ n.id }}" {% if n.id|stringformat:"s" == niveau_selected %}selected{% endif %}>
            {{ n.degre.nom }} — {{ n.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Groupe</div>
      <select id="id_groupe" name="groupe" class="az-select">
        <option value="">Tous</option>
        {% for g in groupes %}
          <option value="{{ g.id }}" {% if g.id|stringformat:"s" == groupe_selected %}selected{% endif %}>
            {{ g.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Date paiement (Du → Au)</div>
      <div class="az-date-range">
        <input class="az-input" type="date" name="date_from" value="{{ date_from_selected }}">
        <span class="az-date-sep">→</span>
        <input class="az-input" type="date" name="date_to" value="{{ date_to_selected }}">
      </div>
      <div class="az-help">Filtre inclusif (>= du) et (<= au).</div>
    </div>
    <button class="az-btn az-btn-soft" type="submit">
      <i class="fa-solid fa-magnifying-glass"></i> Filtrer
    </button>

    <a class="az-btn az-btn-ghost" href="{% url 'core:paiement_list' %}">
      <i class="fa-solid fa-rotate-right"></i> Reset
    </a>

    <div class="az-export">
      <a class="az-btn az-btn-outline"
        href="{% url 'core:paiements_excel_export' %}?annee={{ annee_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&mode={{ mode_selected }}&q={{ q|urlencode }}&date_from={{ date_from_selected }}&date_to={{ date_to_selected }}">
        <i class="fa-solid fa-file-excel"></i> Excel
      </a>
    </div>
  </form>
</div>

<div class="az-card az-paiement-card">
  <div class="az-card-head">
    <h3 class="az-card-title">
      <i class="fa-solid fa-user-group"></i>
      Paiements par parent
    </h3>
  </div>

  <div class="az-table">
    <div class="az-thead">
      <div>Date</div>
      <div>Parent</div>
      <div>Année</div>
      <div>Nb élèves</div>

      {# ✅ NEW #}
      <div>Statut</div>

      {# ✅ NEW: Net #}
      <div>Net</div>

      <div>Mode</div>
      <div class="az-th-actions">Actions</div>
    </div>

    <div class="az-tbody">
      {% for g in groups %}
        <div class="az-row">

          <div class="az-cell">
            <span class="az-badge az-badge-muted">
              <i class="fa-solid fa-calendar-day"></i>
              {{ g.date|date:"Y-m-d" }}
            </span>
          </div>

          <div class="az-cell">
            <span class="az-strong">{{ g.payeur_label }}</span>
   
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-muted">
              <i class="fa-solid fa-calendar-days"></i> {{ annee_active.nom }}
            </span>
          </div>

          <div class="az-cell">
            <b>{{ g.txs|length }}</b>
          </div>

          {# ✅ NEW: STATUT remboursement au niveau parent #}
          <div class="az-cell">
            {% if g.status_code == "ANNULE" %}
              <span class="az-badge az-badge-muted">Annulé</span>
            {% elif g.status_code == "REMBOURSE" %}
              <span class="az-badge az-badge-refund-full">
                <i class="fa-solid fa-rotate-left"></i> Remboursé
              </span>
            {% elif g.status_code == "PARTIEL" %}
              <span class="az-badge az-badge-refund-partial">
                <i class="fa-solid fa-rotate-left"></i> {{ g.status_label }}
              </span>
            {% else %}
              <span class="az-badge az-badge-muted">Payé</span>
            {% endif %}
          </div>

          {# ✅ NEW: NET = brut - remboursé #}
          <div class="az-cell">
            <span class="az-badge az-badge-money">
              <i class="fa-solid fa-sack-dollar"></i> <b>{{ g.total_net }}</b> MAD
            </span>

            {% if g.total_rembourse and g.total_rembourse != 0 %}
              <div class="az-muted" style="margin-top:6px;">
                Brut: <b>{{ g.total_brut }}</b> • Remb.: <b>{{ g.total_rembourse }}</b>
              </div>
            {% endif %}
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-mode {% if g.mode != 'MIXED' %}az-mode-{{ g.mode|lower }}{% endif %}">
              <i class="fa-solid fa-credit-card"></i> {{ g.mode_label }}
            </span>
          </div>

          <div class="az-cell az-actions">

            {# ✅ REÇU : si batch => batch success, sinon tx success #}
            {% if g.batch_token %}
              <a class="az-btn az-btn-outline"
                href="{% url 'core:transaction_batch_success' batch_token=g.batch_token %}">
                <i class="fa-solid fa-receipt"></i> Reçu
              </a>
            {% else %}
              {# solo => on ouvre le success de la 1ère tx (refund_tx_id) #}
              {% if g.refund_tx_id %}
                <a class="az-btn az-btn-outline"
                  href="{% url 'core:transaction_success' tx_id=g.refund_tx_id %}">
                  <i class="fa-solid fa-receipt"></i> Reçu
                </a>
              {% endif %}
            {% endif %}

            {# ✅ REMBOURSER / ANNULER : group_key doit être g.key (TX-id ou batch_token) #}
            {% if g.can_refund_any %}
              <a class="az-btn az-btn-outline"
                href="{% url 'core:paiement_remboursement_create' group_key=g.key %}">
                <i class="fa-solid fa-rotate-left"></i>
                {% if g.total_brut|floatformat:2 == "0.00" %}Annuler{% else %}Rembourser{% endif %}
              </a>
            {% else %}
              <span class="az-btn az-btn-outline az-btn-disabled">
                <i class="fa-solid fa-rotate-left"></i>
                {% if g.status_code == "ANNULE" %}Déjà annulé{% elif g.status_code == "REMBOURSE" %}Déjà remboursé{% else %}—{% endif %}
              </span>
            {% endif %}
          </div>


        </div>
      {% empty %}
        <div class="az-empty">
          <i class="fa-solid fa-inbox"></i>
          <div>Aucun paiement parent.</div>
        </div>
      {% endfor %}
    </div>

  </div>
</div>

<script>
  window.AZ_PAIEMENTS = {
    urlNiveaux: "{% url 'core:ajax_niveaux' %}",
    urlGroupes: "{% url 'core:ajax_groupes' %}"
  };
</script>
<script src="{% static 'admin/js/paiements/list.js' %}"></script>

{% endblock %}
