{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Remboursement | AZ{% endblock %}
{% block page_title %}Remboursement{% endblock %}
{% block current_page %}Finance / Paiements / Rembourser{% endblock %}

{% block content %}
<div class="az-card">
  <div class="az-card-head">
    <h3 class="az-card-title">
      <i class="fa-solid fa-rotate-left"></i>
      {% if is_zero_tx %}
        Annuler / Corriger une transaction (0 MAD)
      {% else %}
        Rembourser une transaction
      {% endif %}
    </h3>
  </div>

  <div class="az-card-body">
    <div class="az-pill">
      <i class="fa-solid fa-user-graduate"></i>
      <span>
        <b>{{ tx.inscription.eleve.matricule }}</b> — {{ tx.inscription.eleve.nom }} {{ tx.inscription.eleve.prenom }}
      </span>
    </div>

    <div class="az-pill" style="margin-top:8px;">
      <i class="fa-solid fa-coins"></i>
      <span>
        Transaction : <b>{{ tx.montant_total }}</b> MAD — Type : <b>{{ tx.get_type_transaction_display }}</b>
      </span>
    </div>

    <div class="az-pill" style="margin-top:8px;">
      <i class="fa-solid fa-circle-info"></i>
      <span>
        {% if is_zero_tx %}
          Cette transaction est à <b>0 MAD</b>. Tu peux l’<b>annuler / corriger</b> (montant = 0).
        {% else %}
          Max remboursable : <b>{{ max_remb }}</b> MAD
        {% endif %}
      </span>
    </div>

    <form method="post" style="margin-top:16px;">
      {% csrf_token %}

      <div class="az-grid" style="display:grid; gap:12px; max-width:520px;">

        <div class="az-field">
          <div class="az-field-label">
            {% if is_zero_tx %}Montant (annulation){% else %}Montant à rembourser{% endif %}
          </div>

          <input
            class="az-input"
            type="number"
            step="0.01"
            min="0"
            name="montant"
            {% if is_zero_tx %}
              value="0"
              readonly
            {% endif %}
            required
          >

          <div class="az-help">
            {% if is_zero_tx %}
              Montant forcé à 0 MAD (annulation / correction).
            {% else %}
              Ne dépasse pas {{ max_remb }} MAD.
            {% endif %}
          </div>
        </div>

        <div class="az-field">
          <div class="az-field-label">Mode</div>
          <select class="az-select" name="mode">
            {% for value, label in modes %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="az-field">
          <div class="az-field-label">Raison (optionnel)</div>
          <input
            class="az-input"
            name="raison"
            placeholder="{% if is_zero_tx %}Annulation transaction 0 (erreur de saisie){% else %}Erreur, désinscription, geste commercial...{% endif %}"
          >
        </div>

        <div style="display:flex; gap:10px;">
          <button class="az-btn az-btn-primary" type="submit">
            <i class="fa-solid fa-check"></i>
            {% if is_zero_tx %}Confirmer l’annulation{% else %}Confirmer le remboursement{% endif %}
          </button>

          <a class="az-btn az-btn-ghost" href="{% url 'core:paiement_list' %}">
            <i class="fa-solid fa-arrow-left"></i> Retour
          </a>
        </div>
      </div>
    </form>

  </div>
</div>
{% endblock %}
