{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Envoyer SMS | AZ{% endblock %}
{% block page_title %}Envoyer SMS{% endblock %}
{% block current_page %}Communication / SMS / Envoi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/sms/send.css' %}?v=1">
{% endblock %}

{% block extra_js %}
<script>
  window.AZ_SMS = {
    urlNiveaux: "{% url 'core:ajax_niveaux' %}",
    urlGroupes: "{% url 'core:ajax_groupes' %}",
    urlEleves: "{% url 'core:ajax_eleves_par_groupe' %}"
  };
</script>
<script src="{% static 'admin/js/sms/send.js' %}?v=1" defer></script>
{% endblock %}

{% block content %}

<div class="azsms">

  <!-- HERO -->
  <div class="azsms-hero">
    <div class="azsms-hero-left">
      <div class="azsms-pill">
        <i class="fa-solid fa-comment-sms"></i>
        <span>Communication</span>
        <span class="sep">•</span>
        <span>Envoi SMS</span>
      </div>

      <h1 class="azsms-title">
        <i class="fa-solid fa-paper-plane"></i>
        Envoyer un SMS
      </h1>

      <p class="azsms-sub">
        Choisis un ciblage (Tous / Degré / Niveau / Groupe / Élève) puis saisis ton message.
      </p>
    </div>

    <div class="azsms-hero-right">
      <a class="az-btn az-btn-ghost" href="{% url 'core:sms_history' %}">
        <i class="fa-solid fa-clock-rotate-left"></i> Historique
      </a>
    </div>
  </div>

  <div class="azsms-grid">

    <!-- FORM CARD -->
    <div class="azsms-card">
      <form method="post" id="smsForm" class="azsms-form">
        {% csrf_token %}

        <!-- Section: Ciblage -->
        <div class="azsms-section">
          <div class="azsms-sec-head">
            <div class="azsms-sec-title">
              <i class="fa-solid fa-bullseye"></i>
              Ciblage
            </div>
            <div class="azsms-sec-hint">Sélectionne le type de cible</div>
          </div>

          <div class="azsms-field">
            <label for="id_cible_type">Type de cible</label>
            {{ form.cible_type }}
            <div class="azsms-help">Si tu choisis “Élève”, fais Groupe → Élève.</div>
          </div>
        </div>

        <!-- Section: Message -->
        <div class="azsms-section">
          <div class="azsms-sec-head">
            <div class="azsms-sec-title">
              <i class="fa-solid fa-pen"></i>
              Message
            </div>
            <div class="azsms-sec-hint">
              <span id="smsCount">0</span>/160 • <span id="smsParts">1</span> SMS
            </div>
          </div>

          <div class="azsms-field">
            <label for="id_message">Contenu</label>
            {{ form.message }}
            <div class="azsms-help">
              Le numéro sera normalisé automatiquement en <b>+212…</b>
            </div>
          </div>
        </div>

        <!-- Section: Cible précise -->
        <div class="azsms-section">
          <div class="azsms-sec-head">
            <div class="azsms-sec-title">
              <i class="fa-solid fa-list-check"></i>
              Cible précise
            </div>
            <div class="azsms-sec-hint">Visible seulement si tu n’es pas sur “TOUS”</div>
          </div>

          <div class="azsms-targets">

            <div class="azsms-field" id="wrap-degre">
              <label for="degre_select">Degré</label>
              <select name="degre" id="degre_select" class="azsms-select">
                <option value="">— Choisir —</option>
                {% for d in degres %}
                  <option value="{{ d.id }}">{{ d.nom }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="azsms-field" id="wrap-niveau">
              <label for="niveau_select">Niveau</label>
              <select name="niveau" id="niveau_select" class="azsms-select" disabled>
                <option value="">— Choisir —</option>
              </select>
            </div>

            <div class="azsms-field" id="wrap-groupe">
              <label for="groupe_select">Groupe</label>
              <select name="groupe" id="groupe_select" class="azsms-select" disabled>
                <option value="">— Choisir —</option>
              </select>
            </div>

            <div class="azsms-field" id="wrap-eleve">
              <label for="eleve_select">Élève</label>
              <select name="eleve" id="eleve_select" class="azsms-select" disabled>
                <option value="">— Choisir —</option>
              </select>
            </div>

          </div>

          <div class="azsms-tip">
            <i class="fa-solid fa-circle-info"></i>
            Astuce : si tu cibles “Élève”, choisis d’abord <b>Groupe</b> puis <b>Élève</b>.
          </div>
        </div>

        <!-- Actions -->
        <div class="azsms-actions">
          <button class="azsms-btn azsms-btn-primary" type="submit">
            <i class="fa-solid fa-paper-plane"></i> Envoyer
          </button>
          <a class="azsms-btn azsms-btn-ghost" href="{% url 'core:sms_history' %}">
            <i class="fa-solid fa-clock-rotate-left"></i> Historique
          </a>
        </div>

      </form>
    </div>

    <!-- SIDE CARD (preview) -->
    <aside class="azsms-side">
      <div class="azsms-side-card">
        <div class="azsms-side-title">
          <i class="fa-regular fa-eye"></i> Aperçu
        </div>
        <div class="azsms-preview" id="smsPreview">Ton message apparaîtra ici…</div>

        <div class="azsms-meta">
          <div class="azsms-meta-item">
            <span class="k">Caractères</span>
            <span class="v" id="smsCount2">0</span>
          </div>
          <div class="azsms-meta-item">
            <span class="k">SMS</span>
            <span class="v" id="smsParts2">1</span>
          </div>
        </div>
      </div>
    </aside>

  </div>

</div>

{% endblock %}
