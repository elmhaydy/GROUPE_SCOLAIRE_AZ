{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Impayés | AZ{% endblock %}
{% block page_title %}Impayés{% endblock %}
{% block current_page %}Finance / Impayés{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/_core/impaye.css' %}?v=1">
{% endblock %}

{% block content %}

<div class="az-page-head">
  <div class="az-page-head-left">
    <div class="az-pill">
      {% if annee_active %}
        <i class="fa-solid fa-circle-check"></i>
        <span>Année active : <b>{{ annee_active.nom }}</b></span>
      {% else %}
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>Aucune année active</span>
      {% endif %}
    </div>
  </div>
<a class="az-nav-link" href="{% url 'core:impayes_mensuels_list' %}">
      <i class="fa-solid fa-calendar-xmark"></i>
      <span>Impayés mensuels</span>
    </a>
  <div class="az-page-head-right">
    <a class="az-btn az-btn-outline" href="#" onclick="window.print();return false;">
      <i class="fa-solid fa-print"></i> Imprimer
    </a>

    <a class="az-btn az-btn-outline"
       href="{% url 'core:impayes_pdf' %}?annee={{ annee_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&q={{ q|urlencode }}">
      <i class="fa-solid fa-file-pdf"></i> PDF
    </a>
  </div>
</div>

<div class="az-kpis">
  <div class="az-kpi az-kpi-due">
    <div class="az-kpi-label">Dû</div>
    <div class="az-kpi-value">{{ total_du }} MAD</div>
  </div>

  <div class="az-kpi az-kpi-paid">
    <div class="az-kpi-label">Encaissé</div>
    <div class="az-kpi-value">{{ total_encaisse }} MAD</div>
  </div>

  <div class="az-kpi az-kpi-unpaid">
    <div class="az-kpi-label">Impayé</div>
    <div class="az-kpi-value">{{ total_impaye }} MAD</div>
  </div>
</div>

<div class="az-filter-bar">
  <form method="get" class="az-filter-form">

    <div class="az-filter-label">
      <i class="fa-solid fa-filter"></i>
      <span>Filtres</span>
    </div>

    <div class="az-field">
      <div class="az-field-label">Recherche</div>
      <input class="az-input" name="q" value="{{ q }}" placeholder="Matricule, nom, groupe...">
    </div>

    <div class="az-field">
      <div class="az-field-label">Année</div>
      <select id="id_annee" name="annee" class="az-select">
        <option value="">(Auto: année active)</option>
        {% for a in annees %}
          <option value="{{ a.id }}" {% if a.id|stringformat:"s" == annee_selected %}selected{% endif %}>
            {{ a.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Niveau</div>
      <select id="id_niveau" name="niveau" class="az-select az-select-wide">
        <option value="">Tous</option>
        {% for n in niveaux %}
          <option value="{{ n.id }}" {% if n.id|stringformat:"s" == niveau_selected %}selected{% endif %}>
            {{ n.degre.nom }} — {{ n.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Groupe</div>
      <select id="id_groupe" name="groupe" class="az-select">
        <option value="">Tous</option>
        {% for g in groupes %}
          <option value="{{ g.id }}" {% if g.id|stringformat:"s" == groupe_selected %}selected{% endif %}>
            {{ g.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Période</div>
      <select id="id_periode" name="periode" class="az-select">
        <option value="">Toutes</option>
        {% for p in periodes %}
          <option value="{{ p.id }}" {% if p.id|stringformat:"s" == periode_selected %}selected{% endif %}>
            {{ p.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <button class="az-btn az-btn-soft" type="submit">
      <i class="fa-solid fa-magnifying-glass"></i> Filtrer
    </button>

    <a class="az-btn az-btn-ghost" href="{% url 'core:impayes_list' %}">
      <i class="fa-solid fa-rotate-right"></i> Reset
    </a>

  </form>
</div>

<div class="az-card az-impaye-card">
  <div class="az-card-head">
    <h3 class="az-card-title">
      <i class="fa-solid fa-triangle-exclamation"></i>
      Liste des impayés (par inscription)
    </h3>
  </div>

  <div class="az-table">
    <div class="az-thead">
      <div>Élève</div>
      <div>Année</div>
      <div>Groupe</div>
      <div>Total dû</div>
      <div>Total payé</div>
      <div>Reste</div>
      <div class="az-th-actions">Action</div>
    </div>

    <div class="az-tbody">
      {% for i in inscriptions %}
        <div class="az-row">
          <div class="az-cell">
            <span class="az-strong">{{ i.eleve.matricule }}</span>
            <span class="az-muted"> — {{ i.eleve.nom }} {{ i.eleve.prenom }}</span>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-muted">
              <i class="fa-solid fa-calendar-days"></i> {{ i.annee.nom }}
            </span>
          </div>

          <div class="az-cell">
            <b>{{ i.groupe.nom }}</b>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-due">
              <i class="fa-solid fa-file-invoice-dollar"></i> {{ i.montant_total }} MAD
            </span>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-paid">
              <i class="fa-solid fa-circle-check"></i> {{ i.total_paye }} MAD
            </span>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-unpaid">
              <i class="fa-solid fa-triangle-exclamation"></i> {{ i.reste }} MAD
            </span>
          </div>

          <div class="az-cell az-actions">
            <a class="az-btn az-btn-outline" href="{% url 'core:paiement_create_for_inscription' i.id %}?nature=INSCRIPTION">
              <i class="fa-solid fa-credit-card"></i> Payer
            </a>

            {% if i.recouvrement %}
              <a class="az-btn az-btn-soft" href="{% url 'core:recouvrement_detail' i.recouvrement.id %}">
                <i class="fa-solid fa-folder-open"></i> Dossier
              </a>
            {% else %}
              <a class="az-btn az-btn-primary" href="{% url 'core:recouvrement_create_for_inscription' i.id %}">
                <i class="fa-solid fa-flag"></i> Ouvrir
              </a>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="az-empty">
          <i class="fa-solid fa-inbox"></i>
          <div>Aucune donnée.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{# ✅ URLs AJAX pour JS séparé #}
<script>
  window.AZ_IMPAYES = {
    urlNiveaux: "{% url 'core:ajax_niveaux' %}",
    urlGroupes: "{% url 'core:ajax_groupes' %}",
    urlPeriodes: "{% url 'core:ajax_periodes' %}"
  };
</script>

<script src="{% static 'admin/js/impayes/impayes.js' %}?v=1"></script>

{% endblock %}
