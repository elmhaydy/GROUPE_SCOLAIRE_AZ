{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Impayés mensuels | AZ{% endblock %}
{% block page_title %}Impayés mensuels{% endblock %}
{% block current_page %}Finance / Impayés mensuels{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/_core/impaye.css' %}?v=3">
{% endblock %}

{% block content %}
<script src="{% static 'admin/js/impayes/mensuels.js' %}?v=6" defer></script>

<div class="az-page-head">
  <div class="az-page-head-left">
    <div class="az-pill">
      {% if annee_active %}
        <i class="fa-solid fa-circle-check"></i>
        <span>
          Année : <b>{{ annee_selected }}</b>
          • Mois courant : <b>{{ mois_courant_nom }}</b>
          • Limite : <b>{{ mois_limit_nom }}</b>
        </span>
      {% else %}
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>Aucune année active</span>
      {% endif %}
    </div>

    <div class="az-chip-group">
      <a class="az-chip {% if type_selected == 'ALL' %}is-active{% endif %}"
         href="?annee={{ annee_selected }}&type=ALL&mois={{ mois_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&q={{ q|urlencode }}">
        Tous
      </a>
      <a class="az-chip {% if type_selected == 'INSCRIPTION' %}is-active{% endif %}"
         href="?annee={{ annee_selected }}&type=INSCRIPTION&mois={{ mois_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&q={{ q|urlencode }}">
        Inscription
      </a>
      <a class="az-chip {% if type_selected == 'SCOLARITE' %}is-active{% endif %}"
         href="?annee={{ annee_selected }}&type=SCOLARITE&mois={{ mois_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&q={{ q|urlencode }}">
        Scolarité
      </a>
      <a class="az-chip {% if type_selected == 'TRANSPORT' %}is-active{% endif %}"
         href="?annee={{ annee_selected }}&type=TRANSPORT&mois={{ mois_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&q={{ q|urlencode }}">
        Transport
      </a>
    </div>
  </div>

  <div class="az-page-head-right">
    <a class="az-btn az-btn-outline" href="#" onclick="window.print();return false;">
      <i class="fa-solid fa-print"></i> Imprimer
    </a>

    <a class="az-btn az-btn-outline"
       href="{% url 'core:impayes_mensuels_excel_export' %}?annee={{ annee_selected }}&type={{ type_selected }}&mois={{ mois_selected }}&niveau={{ niveau_selected }}&groupe={{ groupe_selected }}&periode={{ periode_selected }}&q={{ q|urlencode }}">
      <i class="fa-solid fa-file-excel"></i> Excel
    </a>
  </div>
</div>

<!-- KPIs -->
<div class="az-kpis az-kpis-4">
  <div class="az-kpi az-kpi-unpaid">
    <div class="az-kpi-label">Impayé total</div>
    <div class="az-kpi-value">{{ kpi.impaye }} MAD</div>
    <div class="az-kpi-sub">Dû: {{ kpi.du }} • Encaissé: {{ kpi.encaisse }}</div>
  </div>

  <div class="az-kpi az-kpi-due">
    <div class="az-kpi-label">Scolarité impayée</div>
    <div class="az-kpi-value">{{ kpi.sco_reste }} MAD</div>
    <div class="az-kpi-sub">Dû: {{ kpi.sco_du }} • Payé: {{ kpi.sco_paye }}</div>
  </div>

  <div class="az-kpi az-kpi-transport">
    <div class="az-kpi-label">Transport impayé</div>
    <div class="az-kpi-value">{{ kpi.tr_reste }} MAD</div>
    <div class="az-kpi-sub">Dû: {{ kpi.tr_du }} • Payé: {{ kpi.tr_paye }}</div>
  </div>

  <div class="az-kpi az-kpi-insc">
    <div class="az-kpi-label">Inscription impayée</div>
    <div class="az-kpi-value">{{ kpi.ins_reste }} MAD</div>
    <div class="az-kpi-sub">Dû: {{ kpi.ins_du }} • Payé: {{ kpi.ins_paye }}</div>
  </div>
</div>

<!-- FILTER BAR -->
<div class="az-filter-bar">
  <form method="get" class="az-filter-form">
    <input type="hidden" name="type" value="{{ type_selected }}">

    <div class="az-filter-label">
      <i class="fa-solid fa-filter"></i>
      <span>Filtres</span>
    </div>

    <div class="az-field">
      <div class="az-field-label">Recherche</div>
      <input class="az-input" name="q" value="{{ q }}" placeholder="Matricule, nom, groupe...">
    </div>

    <div class="az-field">
      <div class="az-field-label">Année</div>
      <select id="id_annee" name="annee" class="az-select">
        {% for a in annees %}
          <option value="{{ a.id }}" {% if a.id|stringformat:"s" == annee_selected %}selected{% endif %}>{{ a.nom }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Mois (limite)</div>
      <select id="id_mois" name="mois" class="az-select">
        <option value="">Auto (jusqu’au mois courant)</option>
        {% for i in mois_list %}
          <option value="{{ i }}" {% if i|stringformat:"s" == mois_selected %}selected{% endif %}>
            {% if i == 1 %}Septembre
            {% elif i == 2 %}Octobre
            {% elif i == 3 %}Novembre
            {% elif i == 4 %}Décembre
            {% elif i == 5 %}Janvier
            {% elif i == 6 %}Février
            {% elif i == 7 %}Mars
            {% elif i == 8 %}Avril
            {% elif i == 9 %}Mai
            {% elif i == 10 %}Juin
            {% else %}M{{ i }}{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Niveau</div>
      <select id="id_niveau" name="niveau" class="az-select az-select-wide">
        <option value="">Tous</option>
        {% for n in niveaux %}
          <option value="{{ n.id }}" {% if n.id|stringformat:"s" == niveau_selected %}selected{% endif %}>
            {{ n.degre.nom }} — {{ n.nom }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="az-field">
      <div class="az-field-label">Groupe</div>
      <select id="id_groupe" name="groupe" class="az-select">
        <option value="">Tous</option>
        {% for g in groupes %}
          <option value="{{ g.id }}" {% if g.id|stringformat:"s" == groupe_selected %}selected{% endif %}>{{ g.nom }}</option>
        {% endfor %}
      </select>
    </div>

    <button class="az-btn az-btn-soft" type="submit">
      <i class="fa-solid fa-magnifying-glass"></i> Filtrer
    </button>

    <a class="az-btn az-btn-ghost" href="{% url 'core:impayes_mensuels_list' %}">
      <i class="fa-solid fa-rotate-right"></i> Reset
    </a>
  </form>
</div>

<!-- TABLE -->
<div class="az-card az-impaye-card">
  <div class="az-card-head">
    <h3 class="az-card-title">
      <i class="fa-solid fa-calendar-xmark"></i>
      Impayés (jusqu’au mois courant)
    </h3>
    <p class="az-sub">Affiche uniquement les éléments avec <b>reste &gt; 0</b> et <b>mois ≤ limite</b>.</p>
  </div>

  <div class="az-table">
    <div class="az-thead">
      <div>Type</div>
      <div>Élève</div>
      <div>Mois</div>
      <div>Groupe</div>
      <div>Dû</div>
      <div>Payé</div>
      <div>Reste</div>
      <div class="az-th-actions">Action</div>
    </div>

    <div class="az-tbody">
      {% for r in rows %}
        <div class="az-row">
          <div class="az-cell">
            {% if r.type == "INSCRIPTION" %}
              <span class="az-badge az-badge-insc"><i class="fa-solid fa-id-card"></i> Inscription</span>
            {% elif r.type == "SCOLARITE" %}
              <span class="az-badge az-badge-sco"><i class="fa-solid fa-school"></i> Scolarité</span>
            {% else %}
              <span class="az-badge az-badge-tr"><i class="fa-solid fa-bus"></i> Transport</span>
            {% endif %}
          </div>

          <div class="az-cell">
            <span class="az-strong">{{ r.eleve.matricule }}</span>
            <span class="az-muted"> — {{ r.eleve.nom }} {{ r.eleve.prenom }}</span>
          </div>

          <div class="az-cell">
            <span class="az-badge az-badge-muted">{{ r.mois_nom }}</span>
          </div>

          <div class="az-cell">
            {% if r.groupe %}
              {{ r.groupe.niveau.degre.nom }} / {{ r.groupe.niveau.nom }} / <b>{{ r.groupe.nom }}</b>
            {% else %}
              <span class="az-muted">—</span>
            {% endif %}
          </div>

          <div class="az-cell"><span class="az-badge az-badge-due">{{ r.du }} MAD</span></div>
          <div class="az-cell"><span class="az-badge az-badge-paid">{{ r.paye }} MAD</span></div>
          <div class="az-cell"><span class="az-badge az-badge-unpaid">{{ r.reste }} MAD</span></div>

          <div class="az-cell az-actions">
            {% if r.inscription %}
              <a class="az-btn az-btn-outline"
                 href="{% url 'core:transaction_wizard' %}?inscription_id={{ r.inscription.id }}&type={{ r.type }}">
                <i class="fa-solid fa-credit-card"></i> Payer
              </a>

              {% if r.inscription.recouvrement %}
                <a class="az-btn az-btn-soft" href="{% url 'core:recouvrement_detail' r.inscription.recouvrement.id %}">
                  <i class="fa-solid fa-folder-open"></i> Dossier
                </a>
              {% else %}
                <a class="az-btn az-btn-primary" href="{% url 'core:recouvrement_create_for_inscription' r.inscription.id %}">
                  <i class="fa-solid fa-flag"></i> Ouvrir
                </a>
              {% endif %}
            {% else %}
              <button class="az-btn az-btn-outline" type="button" disabled>
                <i class="fa-solid fa-ban"></i> Payer
              </button>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="az-empty">
          <i class="fa-solid fa-inbox"></i>
          <div>Aucun impayé.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}
